{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}

<header class="bg-dark py-5">
  <div class="container px-4 px-lg-5 my-5">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder">Productos  4x4</h1>
      <p class="lead fw-normal text-white-50 mb-0">Busca por categoria o por compatibilidad de tu auto</p>
    </div>
  </div>
</header>

<div class="container mt-4">
  <div class="row">
    <!-- Filtros -->
    <div class="col-md-3">
      <form method="get" id="filter-form">
        <h5>Buscar productos</h5>
        <input type="text" name="search" class="form-control mb-3" placeholder="Buscar por nombre o descripciÃ³n" value="{{ search_query }}">

        <!-- NUEVO: Filtro de tipo de stock -->
        <h5>Tipo de Stock</h5>
        <select name="stock_type" id="stock-type-select" class="form-select mb-3">
          <option value="">-- Todos --</option>
          <option value="nacional" {% if selected_stock_type == 'nacional' %}selected{% endif %}>Stock Nacional</option>
          <option value="internacional" {% if selected_stock_type == 'internacional' %}selected{% endif %}>Stock Internacional</option>
        </select>
        <br>

        <h5>Filtrar por compatibilidad</h5>
        <label>Marca:</label>
        <select name="brand" id="brand-select" class="form-select mb-2">
          <option value="">-- Todas --</option>
        </select>

        <label>Modelo:</label>
        <select name="model" id="model-select" class="form-select mb-2" disabled>
          <option value="">-- Todas --</option>
        </select>

        <label>Serie:</label>
        <select name="serie" id="serie-select" class="form-select mb-3" disabled>
          <option value="">-- Todas --</option>
        </select>
        <br>

        <h5>Filtrar por categorÃ­a</h5>
        <select name="category" id="category-select" class="form-select mb-2">
          <option value="">-- Todas --</option>
          {% for cat in categories %}
            <option value="{{ cat.name }}" {% if selected_category == cat.name %}selected{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>

        <label>SubcategorÃ­a:</label>
        <select name="subcategory" id="subcategory-select" class="form-select mb-3">
          <option value="">-- Todas --</option>
          {% for subcat in subcategories %}
            <option value="{{ subcat }}" {% if selected_subcategory == subcat %}selected{% endif %}>{{ subcat }}</option>
          {% endfor %}
        </select>
        
        <br>
        <button type="submit" class="btn btn-danger w-100">Aplicar filtros</button>
        <button type="button" id="clear-filters" class="btn btn-secondary w-100 mt-2">Limpiar filtros</button>
        <br><br>
      </form>
    </div>

  <!-- Productos -->
<div class="col-md-9">
  <div class="row">
    {% for product in page_obj %}
      {% if product.is_sale %}
<div class="col-md-4 mb-4">
    <div class="card h-100">
        <div class="badge bg-dark text-white position-absolute" style="top: 0.5rem; right: 0.5rem; z-index: 10;">
            OFERTA
        </div>
        <img src="{{ product.image }}" class="card-img-top" alt="{{ product.name }}" style="height: 250px; object-fit: contain; padding: 10px;">
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text">
                <strike class="text-muted">$ {{ product.price|currency_format }}</strike>
                <span class="text-danger fw-bold ms-2">$ {{ product.sale_price|currency_format }}</span>
            </p>
            
            <!-- Stock badge -->
            {% if product.stock > 0 %}
                <small class="text-success mb-2">âœ“ Stock disponible</small>
            {% elif product.stock_international > 0 %}
                <small class="text-info mb-2">ðŸŒŽ Stock internacional</small>
            {% endif %}
            
            <div class="mt-auto">
                <a href="{% url 'product' product.id %}" class="btn btn-outline-dark w-100 mb-2">Ver mÃ¡s</a>
                {% if product.stock > 0 or product.stock_international > 0 %}
                    <button class="btn btn-success w-100 add-to-cart-btn" 
                            data-product-id="{{ product.id }}"
                            data-max-stock="{% if product.stock > 0 %}{{ product.stock }}{% else %}{{ product.stock_international }}{% endif %}">
                        <i class="bi bi-cart-plus"></i> Agregar al carrito
                    </button>
                {% else %}
                    <button class="btn btn-secondary w-100" disabled>
                        Sin stock
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="col-md-4 mb-4">
    <div class="card h-100">
        <img src="{{ product.image }}" class="card-img-top" alt="{{ product.name }}" style="height: 250px; object-fit: contain; padding: 10px;">
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text">$ {{ product.price|currency_format }}</p>
            
            <!-- Stock badge -->
            {% if product.stock > 0 %}
                <small class="text-success mb-2">âœ“ Stock disponible</small>
            {% elif product.stock_international > 0 %}
                <small class="text-info mb-2">ðŸŒŽ Stock internacional</small>
            {% endif %}
            
            <div class="mt-auto">
                <a href="{% url 'product' product.id %}" class="btn btn-outline-dark w-100 mb-2">Ver mÃ¡s</a>
                {% if product.stock > 0 or product.stock_international > 0 %}
                    <button class="btn btn-danger w-100 add-to-cart-btn" 
                            data-product-id="{{ product.id }}"
                            data-max-stock="{% if product.stock > 0 %}{{ product.stock }}{% else %}{{ product.stock_international }}{% endif %}">
                        <i class="bi bi-cart-plus"></i> Agregar al carrito
                    </button>
                {% else %}
                    <button class="btn btn-secondary w-100" disabled>
                        Sin stock
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
    {% empty %}
      <p>No se encontraron productos con los filtros seleccionados.</p>
    {% endfor %}
  </div>


  </div>
</div>

<script>
jQuery(document).ready(function($) {
  const brandSelect = document.getElementById('brand-select');
  const modelSelect = document.getElementById('model-select');
  const serieSelect = document.getElementById('serie-select');
  const categorySelect = document.getElementById('category-select');
  const subcategorySelect = document.getElementById('subcategory-select');

  let compatData = {{ compat_data|safe }};
  let isUpdating = false; // Bandera para evitar loops

  // ===== MANTENER POSICIÃ“N DEL SCROLL =====
  if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
  }

  const scrollPos = sessionStorage.getItem('scrollPos');
  if (scrollPos) {
    document.documentElement.scrollTop = document.body.scrollTop = parseInt(scrollPos);
    sessionStorage.removeItem('scrollPos');
  }

  // ===== FUNCIÃ“N PARA ACTUALIZAR FILTROS CON AJAX =====
  function updateFiltersAjax() {
    if (isUpdating) return;
    isUpdating = true;

    const params = new URLSearchParams({
      category: categorySelect.value,
      subcategory: subcategorySelect.value,
      brand: brandSelect.value,
      model: modelSelect.value,
      serie: serieSelect.value,
      stock_type: document.getElementById('stock-type-select').value
    });

    $.ajax({
      url: "{% url 'get_dynamic_filters' %}?" + params.toString(),
      type: 'GET',
      success: function(data) {
        // Guardar valores actuales
        const currentCategory = categorySelect.value;
        const currentSubcategory = subcategorySelect.value;
        const currentBrand = brandSelect.value;
        const currentModel = modelSelect.value;
        const currentSerie = serieSelect.value;

        // Actualizar categorÃ­as
        categorySelect.innerHTML = '<option value="">-- Todas --</option>';
        data.categories.forEach(cat => {
          const option = new Option(cat.name, cat.name);
          if (cat.name === currentCategory) option.selected = true;
          categorySelect.add(option);
        });

        // Actualizar subcategorÃ­as
        subcategorySelect.innerHTML = '<option value="">-- Todas --</option>';
        data.subcategories.forEach(subcat => {
          const option = new Option(subcat, subcat);
          if (subcat === currentSubcategory) option.selected = true;
          subcategorySelect.add(option);
        });

        // Actualizar compatibilidades
        compatData = data.compat_data;
        
        // Actualizar marcas
        brandSelect.innerHTML = '<option value="">-- Todas --</option>';
        for (const brand in compatData) {
          const option = new Option(brand, brand);
          if (brand === currentBrand) option.selected = true;
          brandSelect.add(option);
        }

        // Recargar modelos y series segÃºn marca actual
        if (currentBrand && compatData[currentBrand]) {
          loadModels(currentBrand, currentModel);
          if (currentModel && compatData[currentBrand][currentModel]) {
            loadSeries(currentBrand, currentModel, currentSerie);
          }
        }

        isUpdating = false;
      },
      error: function() {
        console.error('Error al actualizar filtros');
        isUpdating = false;
      }
    });
  }

  // ===== CARGAR MARCAS INICIALES =====
  for (const brand in compatData) {
    const option = new Option(brand, brand);
    if (brand === "{{ selected_brand }}") option.selected = true;
    brandSelect.add(option);
  }

  function loadModels(brand, selectedModel = null) {
    modelSelect.innerHTML = '<option value="">-- Todas --</option>';
    serieSelect.innerHTML = '<option value="">-- Todas --</option>';
    serieSelect.disabled = true;

    if (!brand || !compatData[brand]) {
      modelSelect.disabled = true;
      return;
    }

    modelSelect.disabled = false;
    for (const model in compatData[brand]) {
      const option = new Option(model, model);
      if (model === selectedModel || model === "{{ selected_model }}") option.selected = true;
      modelSelect.add(option);
    }
  }

  function loadSeries(brand, model, selectedSerie = null) {
    serieSelect.innerHTML = '<option value="">-- Todas --</option>';
    
    if (!brand || !model || !compatData[brand] || !compatData[brand][model]) {
      serieSelect.disabled = true;
      return;
    }
    
    serieSelect.disabled = false;
    compatData[brand][model].forEach(serie => {
      const option = new Option(serie, serie);
      if (serie === selectedSerie || serie === "{{ selected_serie }}") option.selected = true;
      serieSelect.add(option);
    });
  }

  // ===== INICIALIZAR SI HAY VALORES SELECCIONADOS =====
  const selectedBrand = "{{ selected_brand }}";
  const selectedModel = "{{ selected_model }}";
  
  if (selectedBrand && compatData[selectedBrand]) {
    loadModels(selectedBrand);
    if (selectedModel && compatData[selectedBrand][selectedModel]) {
      loadSeries(selectedBrand, selectedModel);
    }
  }

  // ===== EVENT LISTENERS PARA ACTUALIZAR FILTROS CON AJAX =====
  brandSelect.addEventListener('change', function() {
    loadModels(this.value);
    updateFiltersAjax();
  });

  modelSelect.addEventListener('change', function() {
    loadSeries(brandSelect.value, this.value);
    updateFiltersAjax();
  });

  serieSelect.addEventListener('change', function() {
    updateFiltersAjax();
  });

  categorySelect.addEventListener('change', function() {
    updateFiltersAjax();
  });

  subcategorySelect.addEventListener('change', function() {
    updateFiltersAjax();
  });

  document.getElementById('stock-type-select').addEventListener('change', function() {
  updateFiltersAjax();
})

  // ===== GUARDAR SCROLL AL ENVIAR FORMULARIO =====
  document.getElementById('filter-form').addEventListener('submit', function() {
    sessionStorage.setItem('scrollPos', window.pageYOffset || document.documentElement.scrollTop);
  });

  // ===== LIMPIAR FILTROS =====
  document.getElementById('clear-filters').addEventListener('click', function() {
    sessionStorage.removeItem('scrollPos');
    window.location.href = window.location.pathname;
  });

  // ===== GUARDAR SCROLL AL HACER CLIC EN PRODUCTOS =====
  document.querySelectorAll('a[href*="/product/"]').forEach(link => {
    link.addEventListener('click', function() {
      sessionStorage.setItem('scrollPos', window.pageYOffset || document.documentElement.scrollTop);
    });
  });

  // ===== AGREGAR AL CARRITO =====
  $(document).on('click', '.add-to-cart-btn', function(e) {
    e.preventDefault();
    
    const button = $(this);
    const productId = button.data('product-id');
    
    button.prop('disabled', true);
    const originalText = button.html();
    button.html('<span class="spinner-border spinner-border-sm"></span> Agregando...');
    
    $.ajax({
      type: 'POST',
      url: "{% url 'cart_add' %}",
      data: {
        product_id: productId,
        product_quantity: 1,
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function(json) {
        $('#cart_quantity').text(json.quantity);
        
        button.html('<i class="bi bi-check-circle"></i> Agregado');
        button.removeClass('btn-success btn-danger').addClass('btn-primary');
        
        setTimeout(function() {
          button.html(originalText);
          button.removeClass('btn-primary').addClass('btn-success');
          button.prop('disabled', false);
        }, 1000);
        
        showNotification('Producto agregado al carrito');
      },
      error: function(xhr, errmsg, err) {
        console.error("Error:", errmsg);
        button.html('<i class="bi bi-x-circle"></i> Error');
        button.removeClass('btn-success btn-danger').addClass('btn-danger');
        
        setTimeout(function() {
          button.html(originalText);
          button.removeClass('btn-danger').addClass('btn-success');
          button.prop('disabled', false);
        }, 2000);
        
        showNotification('Error al agregar al carrito', 'error');
      }
    });
  });

  function showNotification(message, type = 'success') {
    const bgColor = type === 'success' ? '#28a745' : '#dc3545';
    const notification = $('<div>')
      .text(message)
      .css({
        position: 'fixed',
        top: '20px',
        right: '20px',
        backgroundColor: bgColor,
        color: 'white',
        padding: '15px 20px',
        borderRadius: '5px',
        zIndex: 9999,
        boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
      });
    
    $('body').append(notification);
    
    setTimeout(function() {
      notification.fadeOut(300, function() {
        $(this).remove();
      });
    }, 3000);
  }

});
</script>

{% endblock %}