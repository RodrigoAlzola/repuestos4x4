{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}

<header class="bg-dark py-5">
  <div class="container px-4 px-lg-5 my-5">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder">Productos  4x4</h1>
      <p class="lead fw-normal text-white-50 mb-0">Busca por categoria o por compatibilidad de tu auto</p>
    </div>
  </div>
</header>

<div class="container mt-4">
  <div class="row">
    <!-- Filtros -->
    <div class="col-md-3">
      <form method="get" id="filter-form">
        <h5>Buscar productos</h5>
        <input type="text" name="search" class="form-control mb-3" placeholder="Buscar por nombre o descripción" value="{{ search_query }}">

        <h5>Filtrar por categoría</h5>
        <select name="category" id="category-select" class="form-select mb-2">
          <option value="">-- Todas --</option>
          {% for cat in categories %}
            <option value="{{ cat.name }}" {% if selected_category == cat.name %}selected{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>

        <!-- Nuevo: Filtro de subcategoría -->
        <label>Subcategoría:</label>
        <select name="subcategory" id="subcategory-select" class="form-select mb-3" {% if not selected_category %}disabled{% endif %}>
          <option value="">-- Todas --</option>
          {% for subcat in subcategories %}
            <option value="{{ subcat }}" {% if selected_subcategory == subcat %}selected{% endif %}>{{ subcat }}</option>
          {% endfor %}
        </select>

        <h5>Filtrar por compatibilidad</h5>
        <label>Marca:</label>
        <select name="brand" id="brand-select" class="form-select mb-2">
          <option value="">-- Todas --</option>
        </select>

        <label>Modelo:</label>
        <select name="model" id="model-select" class="form-select mb-2" disabled>
          <option value="">-- Todas --</option>
        </select>

        <label>Serie:</label>
        <select name="serie" id="serie-select" class="form-select mb-3" disabled>
          <option value="">-- Todas --</option>
        </select>

        <button type="submit" class="btn btn-primary w-100">Aplicar filtros</button>
        <br><br>
      </form>
    </div>

    <!-- Productos -->
    <div class="col-md-9">
      <div class="row">
        {% for product in page_obj %}
          {% if product.is_sale %}
<div class="col-md-4 mb-4">
    <div class="card h-100">
        <!-- Sale badge-->
        <div class="badge bg-dark text-white position-absolute" style="top: 0.5rem; right: 0.5rem; z-index: 10;">
            OFERTA
        </div>
        <img src="{{ product.image }}" class="card-img-top" alt="{{ product.name }}" style="height: 250px; object-fit: contain; padding: 10px;">
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text">
                <strike class="text-muted">$ {{ product.price|currency_format }}</strike>
                <span class="text-danger fw-bold ms-2">$ {{ product.sale_price|currency_format }}</span>
            </p>
            <a href="{% url 'product' product.id %}?{% if selected_brand %}brand={{ selected_brand }}&{% endif %}{% if selected_model %}model={{ selected_model }}&{% endif %}{% if selected_serie %}serie={{ selected_serie }}{% endif %}" class="btn btn-outline-dark mt-auto">Ver más</a>
        </div>
    </div>
</div>
{% else %}
<div class="col-md-4 mb-4">
    <div class="card h-100">
        <img src="{{ product.image }}" class="card-img-top" alt="{{ product.name }}" style="height: 250px; object-fit: contain; padding: 10px;">
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text">$ {{ product.price|currency_format }}</p>
            <a href="{% url 'product' product.id %}?{% if selected_brand %}brand={{ selected_brand }}&{% endif %}{% if selected_model %}model={{ selected_model }}&{% endif %}{% if selected_serie %}serie={{ selected_serie }}{% endif %}" class="btn btn-outline-dark mt-auto">Ver más</a>
        </div>
    </div>
</div>
{% endif %}
        {% empty %}
          <p>No se encontraron productos con los filtros seleccionados.</p>
        {% endfor %}
      </div>

      <!-- Paginación -->
      <nav>
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
            </li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Script para filtros en cascada -->
<script>
  const compatData = {{ compat_data|safe }};
  
  // Selects de compatibilidad
  const brandSelect = document.getElementById('brand-select');
  const modelSelect = document.getElementById('model-select');
  const serieSelect = document.getElementById('serie-select');
  
  // Nuevos selects de categoría/subcategoría
  const categorySelect = document.getElementById('category-select');
  const subcategorySelect = document.getElementById('subcategory-select');

  // ===== FUNCIONALIDAD DE CATEGORÍA/SUBCATEGORÍA =====
  // Datos de subcategorías por categoría (generados desde Django)
  const subcategoryData = {};
  
  {% for cat in categories %}
    subcategoryData["{{ cat.name }}"] = [
      {% for subcat in subcategories %}
        "{{ subcat }}",
      {% endfor %}
    ];
  {% endfor %}

  // Evento: Al cambiar categoría, habilitar/deshabilitar subcategoría
  categorySelect.addEventListener('change', function() {
    const selectedCategory = this.value;
    
    if (selectedCategory) {
      // Habilitar subcategoría y hacer fetch de subcategorías
      subcategorySelect.disabled = false;
      
      // Hacer una petición AJAX para obtener subcategorías dinámicamente
      fetch(`?category=${selectedCategory}`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.text())
      .then(html => {
        // Extraer subcategorías del HTML de respuesta
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newSubcategories = doc.querySelectorAll('#subcategory-select option');
        
        // Limpiar y repoblar
        subcategorySelect.innerHTML = '<option value="">-- Todas --</option>';
        newSubcategories.forEach(option => {
          if (option.value) {
            subcategorySelect.appendChild(option.cloneNode(true));
          }
        });
      })
      .catch(error => {
        console.error('Error cargando subcategorías:', error);
      });
    } else {
      // Deshabilitar y limpiar subcategoría
      subcategorySelect.disabled = true;
      subcategorySelect.innerHTML = '<option value="">-- Todas --</option>';
    }
  });

  // ===== FUNCIONALIDAD DE COMPATIBILIDAD (EXISTENTE) =====
  // Cargar marcas
  for (const brand in compatData) {
    const option = document.createElement('option');
    option.value = brand;
    option.textContent = brand;
    if (brand === "{{ selected_brand }}") option.selected = true;
    brandSelect.appendChild(option);
  }

  function loadModels(brand) {
    modelSelect.innerHTML = '<option value="">-- Todas --</option>';
    serieSelect.innerHTML = '<option value="">-- Todas --</option>';
    serieSelect.disabled = true;

    if (brand && compatData[brand]) {
      modelSelect.disabled = false;
      for (const model in compatData[brand]) {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        if (model === "{{ selected_model }}") option.selected = true;
        modelSelect.appendChild(option);
      }
    } else {
      modelSelect.disabled = true;
    }
  }

  function loadSeries(brand, model) {
    serieSelect.innerHTML = '<option value="">-- Todas --</option>';
    if (brand && model && compatData[brand][model]) {
      serieSelect.disabled = false;
      compatData[brand][model].forEach(serie => {
        const option = document.createElement('option');
        option.value = serie;
        option.textContent = serie;
        if (serie === "{{ selected_serie }}") option.selected = true;
        serieSelect.appendChild(option);
      });
    } else {
      serieSelect.disabled = true;
    }
  }

  brandSelect.addEventListener('change', () => {
    loadModels(brandSelect.value);
  });

  modelSelect.addEventListener('change', () => {
    loadSeries(brandSelect.value, modelSelect.value);
  });

  // Cargar modelos y series si ya hay selección
  if ("{{ selected_brand }}") {
    loadModels("{{ selected_brand }}");
    if ("{{ selected_model }}") {
      loadSeries("{{ selected_brand }}", "{{ selected_model }}");
    }
  }
</script>

{% endblock %}