{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}

<div class="container">
  <br/>
  <div class="card mb-3">
    <div class="row g-0">
      <div class="col-md-4">
        <img src="{{ product.image }}" class="img-fluid rounded-start" alt="Imagen del producto">
      </div>
      <div class="col-md-8">
        <div class="card-body">
          <!-- Botón Compartir arriba a la derecha -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h5 class="card-title mb-0">{{ product.name }}</h5>
            <button type="button" class="btn btn-secondary btn-sm" id="share-button">
              <i class="bi bi-share"></i> Compartir
            </button>
          </div>

          <!--<p class="card-text">{{ product.description }}</p> -->
          <br/><br/>
          <ul class="list-group list-group-flush">
            {% if product.motor %}
              <li class="list-group-item"><strong>Motor:</strong> {{ product.motor }}</li>
            {% endif %}
            <li class="list-group-item"><strong>Peso (kg):</strong> {{ product.weight_kg }}</li>
            <li class="list-group-item"><strong>Dimensiones (cm):</strong> {{ product.length_cm }} x {{ product.width_cm }} x {{ product.height_cm }}</li>
            <li class="list-group-item"><strong>Volumen (m³):</strong> {{ product.volume_m3 }}</li>
            
            <!-- Stock con indicador de tipo -->
            {% if product.stock > 0 %}
              <li class="list-group-item">
                <strong>Stock:</strong> 
                {% if product.stock > 30 %}
                  <span class="badge bg-warning">+30 disponibles
                    <span class="text ms-2">Entrega inmediata</span>
                  </span>
                {% else %}
                  <span class="badge bg-warning">{{ product.stock }} disponibles
                    <span class="text ms-2">Entrega inmediata</span>
                  </span>
                {% endif %}
                <br>
                <small class="text-muted">Tiempo de entrega: 5-10 días hábiles</small>
              </li>

            {% elif product.stock_international > 0 %}
              <li class="list-group-item">
                <strong>Stock:</strong> 
                {% if product.stock_international > 30 %}
                  <span class="badge bg-info">+30 disponibles
                    <i class="bi bi-globe ms-2"></i> Compra Internacional
                  </span>
                {% else %}
                  <span class="badge bg-info">{{ product.stock_international }} disponibles
                    <i class="bi bi-globe ms-2"></i> Compra Internacional
                  </span>
                {% endif %}
                <br>
                <small class="text-muted">Tiempo de entrega: 15-30 días hábiles</small>
              </li>
            {% else %}
              <li class="list-group-item">
                <strong>Stock:</strong> 
                <span class="badge bg-danger">Sin stock disponible</span>
              </li>
            {% endif %}
          </ul>

      
          <div class="text-end">
            {% if product.is_sale %}
              <p class="fs-4 text-danger">
                <strike class="text-muted">$ {{ product.price|currency_format }}</strike><br/>
                <strong>$ Precio: {{ product.sale_price|currency_format }}</strong>
              </p>
            {% else %}
              <p class="fs-4 text-dark"><strong>$ Precio: {{ product.price|currency_format }}</strong></p>
            {% endif %}
          </div>

          <br/>
          <!-- Compatibilidad seleccionada -->
          <h6>Compatibilidad seleccionada:</h6>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="brand-select">Marca:</label>
              <select id="brand-select" class="form-select">
                <option value="">-- Selecciona una marca --</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="model-select">Modelo:</label>
              <select id="model-select" class="form-select" disabled>
                <option value="">-- Selecciona un modelo --</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="serie-select">Serie:</label>
              <select id="serie-select" class="form-select" disabled>
                <option value="">-- Selecciona una serie --</option>
              </select>
            </div>
          </div>
          <br/>

          <!-- Cantidad -->
          <div class="row justify-content-end">
            <div class="col-md-6 text-end">
              {% if product.stock > 0 or product.stock_international > 0 %}
                <label for="quantity-cart" class="form-label fw-bold">Cantidad:</label>
                <select class="form-select form-select-sm w-auto d-inline-block" id="quantity-cart">
                  {% if product.stock > 0 %}
                    {% for i in quantity_range %}
                      <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                  {% else %}
                    {% for i in quantity_range_international %}
                      <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                  {% endif %}
                </select>
              {% else %}
                <p class="text-danger fw-bold">Producto sin stock disponible.</p>
              {% endif %}
            </div>
          </div>

          <br/>
          <div class="text-end">
            {% if product.stock > 0 or product.stock_international > 0 %}
              <button type="button" value="{{ product.id }}" class="btn btn-danger btn-lg" id="add-cart">
                <i class="bi bi-cart-plus me-2"></i>Agregar al Carrito
              </button>
            {% else %}
              <button type="button" class="btn btn-secondary btn-lg" disabled>
                <i class="bi bi-x-circle me-2"></i>Sin Stock
              </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<br/>

<!-- Script para compartir -->
<script>
  document.getElementById('share-button').addEventListener('click', function() {
    const productName = "{{ product.name|escapejs }}";
    const productURL = window.location.href;
    const shareText = `Mira este producto: ${productName}`;
    
    // Web Share API (para móviles principalmente)
    if (navigator.share) {
      navigator.share({
        title: productName,
        text: shareText,
        url: productURL
      })
      .then(() => console.log('Compartido exitosamente'))
      .catch((error) => console.log('Error al compartir:', error));
    } else {
      // Fallback: copiar al portapapeles
      navigator.clipboard.writeText(productURL)
        .then(() => {
          // Cambiar texto del botón temporalmente
          const btn = document.getElementById('share-button');
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '<i class="bi bi-check-circle"></i> ¡Copiado!';
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-success');
          
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
          }, 2000);
        })
        .catch(err => {
          alert('No se pudo copiar el enlace');
        });
    }
  });
</script>

<!-- Script para compatibilidad seleccionada -->
<script>
  const compatData = {{ compat_data|safe }};
  const selectedBrand = "{{ selected_brand }}";
  const selectedModel = "{{ selected_model }}";
  const selectedSerie = "{{ selected_serie }}";

  const brandSelect = document.getElementById('brand-select');
  const modelSelect = document.getElementById('model-select');
  const serieSelect = document.getElementById('serie-select');

  // Cargar marcas
  for (const brand in compatData) {
    const option = new Option(brand, brand);
    if (brand === selectedBrand) option.selected = true;
    brandSelect.appendChild(option);
  }

  // Cargar modelos si hay marca seleccionada
  if (selectedBrand && compatData[selectedBrand]) {
    modelSelect.disabled = false;
    for (const model in compatData[selectedBrand]) {
      const option = new Option(model, model);
      if (model === selectedModel) option.selected = true;
      modelSelect.appendChild(option);
    }
  }

  // Cargar series si hay modelo seleccionada
  if (selectedBrand && selectedModel && compatData[selectedBrand][selectedModel]) {
    serieSelect.disabled = false;
    compatData[selectedBrand][selectedModel].forEach(serie => {
      const option = new Option(serie, serie);
      if (serie === selectedSerie) option.selected = true;
      serieSelect.appendChild(option);
    });
  }

  // Event listener para cambios en marca
  brandSelect.addEventListener('change', function() {
    const brand = this.value;
    
    modelSelect.innerHTML = '<option value="">-- Selecciona un modelo --</option>';
    modelSelect.disabled = true;
    serieSelect.innerHTML = '<option value="">-- Selecciona una serie --</option>';
    serieSelect.disabled = true;
    
    if (brand && compatData[brand]) {
      modelSelect.disabled = false;
      for (const model in compatData[brand]) {
        modelSelect.appendChild(new Option(model, model));
      }
      updateURL(brand, '', '');
    } else {
      updateURL('', '', '');
    }
  });

  // Event listener para cambios en modelo
  modelSelect.addEventListener('change', function() {
    const brand = brandSelect.value;
    const model = this.value;
    
    serieSelect.innerHTML = '<option value="">-- Selecciona una serie --</option>';
    serieSelect.disabled = true;
    
    if (brand && model && compatData[brand][model]) {
      serieSelect.disabled = false;
      compatData[brand][model].forEach(serie => {
        serieSelect.appendChild(new Option(serie, serie));
      });
      updateURL(brand, model, '');
    }
  });

  // Event listener para cambios en serie
  serieSelect.addEventListener('change', function() {
    const brand = brandSelect.value;
    const model = modelSelect.value;
    const serie = this.value;
    updateURL(brand, model, serie);
  });

  // Función para actualizar la URL y recargar la página
  function updateURL(brand, model, serie) {
    const params = new URLSearchParams();
    if (brand) params.append('brand', brand);
    if (model) params.append('model', model);
    if (serie) params.append('serie', serie);
    const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.location.href = newURL;
  }
</script>

<!-- Script para agregar al carrito -->
<script>
$(document).on('click', '#add-cart', function(e){
  e.preventDefault();
  $.ajax({
    type: 'POST',
    url: "{% url 'cart_add' %}",
    data: {
      product_id: $(this).val(),
      product_quantity: $('#quantity-cart option:selected').text(),
      csrfmiddlewaretoken: '{{ csrf_token }}',
      action: 'post'
    },
    success: function(json){
      document.getElementById("cart_quantity").textContent = json.quantity;
      location.reload();
    },
    error: function(xhr, errmsg, err){
      console.log("Error al agregar al carrito");
    }
  });
});
</script>

{% endblock %}