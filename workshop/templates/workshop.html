{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
        <!-- Header-->
        <header class="bg-dark py-5">
            <div class="container px-4 px-lg-5 my-5">
                <div class="text-center text-white">
                    <h1 class="display-4 fw-bolder">Select your Workshop!</h1>
                    <p class="lead fw-normal text-white-50 mb-0">Elige un Taller para que enviemos tu repuesto!</p>
                </div>
            </div>
        </header>
        <br/>
<div class="container-fluid px-3">

  <div class="row">
    <!-- Workshops on the left -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header">
          Select your Workshop
        </div>
        <div class="card-body">
          
          {% if not user.is_authenticated %}
            <!-- Mensaje para usuarios no autenticados -->
            <div class="alert alert-warning" role="alert">
              <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Inicio de sesión requerido</h5>
              <p>Para seleccionar un taller de instalación, debes <a href="{% url 'login' %}" class="alert-link">iniciar sesión</a> o <a href="{% url 'register' %}" class="alert-link">registrarte</a>.</p>
              <hr>
              <p class="mb-0">Aún puedes comprar tus repuestos y recibirlos en la dirección que indiques más adelante.</p>
            </div>
          {% endif %}

          <div class="row {% if not user.is_authenticated %}opacity-50 pe-none{% endif %}">
            {% for item in workshops %}
              <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 d-flex flex-column p-2 {% if not user.is_authenticated %}bg-light{% endif %}">
                  {% if item.logo %}
                    <img src="{{ item.logo.url }}" class="card-img-top" alt="{{ item.name }}" style="height: 150px; object-fit: contain;">
                  {% endif %}
                  <div class="card-body d-flex flex-column p-2">
                    <div class="mt-auto">
                      <p class="card-text">
                        <h5 class="card-title">{{ item.name }}</h5>
                        {{ item.address1 }}<br>
                        {{ item.commune }}, {{ item.city }}
                      </p>
                      <a href="{% url 'checkout' %}?workshop_id={{ item.id }}" 
                         class="btn btn-success {% if not user.is_authenticated %}disabled{% endif %}">
                        Seleccionar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          
          <div class="text-end">
            <a href="{% url 'checkout' %}" class="btn btn-danger">
              {% if user.is_authenticated %}
                Continue without Workshop
              {% else %}
                Continue to Checkout
              {% endif %}
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Order summary on the right -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <i class="bi bi-cart3 me-2"></i>Resumen de Orden
        </div>
        <div class="card-body">
          {% for product in cart_products %}
            <strong>{{ product.name }}</strong><br>
            {% if product.is_sale %}
              <strike>$ {{ product.price|currency_format }}</strike> &nbsp; $ {{ product.sale_price|currency_format }}
            {% else %}
              $ {{ product.price|currency_format }}
            {% endif %}
            <br>
            <small>Cantidad:</small>
            {% for key, value in quantities.items %}
              {% if key == product.id|slugify %}
                {{ value }}
              {% endif %}
            {% endfor %}
            <br><br>
          {% endfor %}
          <hr>
          <h5><strong>Total: ${{ total|currency_format }} CLP</strong></h5> 
          (con IVA incluido)
          <br><br>
          <a href="{% url 'cart_summary' %}" class="btn btn-sm btn-outline-secondary w-100">
            <i class="bi bi-pencil me-2"></i>Actualizar Items
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<br/><br/>
{% endblock %}