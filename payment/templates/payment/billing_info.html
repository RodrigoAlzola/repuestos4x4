{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<!-- Header -->
<header class="bg-dark py-5">
  <div class="container px-4 px-lg-5 my-5">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder">Información de Pago</h1>
      <p class="lead fw-normal text-white-50 mb-0">Revisa tu información y confirma tu compra</p>
    </div>
  </div>
</header>
<br/>

<div class="container-fluid px-3">
  <div class="row justify-content-between">
    <!-- Billing Info Section -->
    <div class="col-lg-6 mx-auto">
      <!-- CAMBIO: action apunta a 'billing_info' en lugar de 'process_payment' -->
      <form method="POST" action="{% url 'billing_info' %}" id="paymentForm">
        {% csrf_token %}

        <!-- Personal Info -->
        <div class="card mb-4">
          <div class="card-header bg-danger text-white">
            <i class="bi bi-person-circle me-2"></i>Información Personal
          </div>
          <div class="card-body">
            <div class="mb-1"><strong>Nombre:</strong> {{ personal_info.full_name }}</div>
            <div class="mb-1"><strong>Teléfono:</strong> {{ personal_info.phone }}</div>
            <div class="mb-1"><strong>Email:</strong> {{ personal_info.email }}</div>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="card mb-4">
          <div class="card-header bg-dark text-white">
            <i class="bi bi-geo-alt me-2"></i>Dirección de Envío 
          </div>
          <div class="card-body">
            <div class="mb-1"><strong>Nombre:</strong> {{ shipping_info.shipping_full_name }}</div>
            <div class="mb-1"><strong>RUT:</strong> {{ shipping_info.shipping_id_number }}</div>
            <div class="mb-1"><strong>Dirección:</strong> {{ shipping_info.shipping_address1 }}</div>
            {% if shipping_info.shipping_address2 %}
              <div class="mb-1"><strong>Depto/Oficina:</strong> {{ shipping_info.shipping_address2 }}</div>
            {% endif %}
            <div class="mb-1"><strong>Comuna:</strong> {{ shipping_info.shipping_commune }}</div>
            <div class="mb-1"><strong>Ciudad:</strong> {{ shipping_info.shipping_city }}</div>
            {% if shipping_info.shipping_state %}
              <div class="mb-1"><strong>Región:</strong> {{ shipping_info.shipping_state }}</div>
            {% endif %}
            {% if shipping_info.shipping_zipcode %}
              <div class="mb-1"><strong>Código Postal:</strong> {{ shipping_info.shipping_zipcode }}</div>
            {% endif %}
            <div class="mb-1"><strong>País:</strong> {{ shipping_info.shipping_country }}</div>
          </div>
        </div>

        <!-- Mensaje de destino -->
        <div class="alert {% if is_workshop_shipping %}alert-info{% else %}alert-dark{% endif %} text-center">
          {% if not is_workshop_shipping %}
            Todos nuestros envios son por pagar al currier nacional.
          {% endif %}
        </div>

        <!-- Método de Pago -->
        <div class="card mb-4">
          <div class="card-header bg-danger text-white">
            <i class="bi bi-credit-card me-2"></i>Selecciona tu método de pago
          </div>
          <div class="card-body">
            <div class="row">
              <!-- Transbank/WebPay -->
              <div class="col-md-6 mb-3">
                <input type="radio" class="btn-check" name="payment_method" id="webpay" value="transbank" checked required>
                <label class="btn btn-outline-payment w-100 d-flex flex-column align-items-center py-3" for="webpay">
                  {% load static %}
                  <img src="{% static 'images/webpay-logo.png' %}" alt="WebPay" style="height: 50px; margin-bottom: 10px;">
                  <span>Transbank</span> 
                  <small class="text-muted">Pago inmediato con tarjeta</small>
                </label>
              </div>

              <!-- Transferencia Bancaria -->
              <div class="col-md-6 mb-3">
                <input type="radio" class="btn-check" name="payment_method" id="transferencia" value="bank_transfer">
                <label class="btn btn-outline-payment w-100 d-flex flex-column align-items-center py-3" for="transferencia">
                  <i class="bi bi-bank2" style="font-size: 50px; margin-bottom: 10px;"></i>
                  <span>Transferencia Bancaria</span>
                  <small class="text-muted">Confirmaremos tu pedido</small>
                </label>
              </div>
            </div>

            <!-- Información del método seleccionado -->
            <div id="payment-info" class="alert alert-dark mt-3">
              <i class="bi bi-shield-check me-2"></i>
              <strong>Transbank:</strong> Serás redirigido a la pasarela de pago segura de Transbank para completar tu compra.
            </div>
          </div>
        </div>

        <!-- Términos y Condiciones -->
        <div class="card mb-4 border-warning">
          <div class="card-body">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="termsCheckbox" required>
              <label class="form-check-label" for="termsCheckbox">
                Acepto los <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal" onclick="event.preventDefault();">Términos y Condiciones</a>
              </label>
            </div>
            <input type="hidden" name="terms_accepted" id="termsAcceptedInput" value="">
          </div>
        </div>

        <br/>
        <!-- Botones de navegación -->
        <div class="d-flex justify-content-between">
          <a href="{% url 'checkout' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Volver
          </a>
          <button type="submit" id="payButton" class="btn btn-danger" disabled>
            <span id="buttonText">Pagar Ahora</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Order summary -->
<div class="col-md-4">
  <div class="card">
    <div class="card-header bg-dark text-white">
      <i class="bi bi-cart3 me-2"></i>Resumen de Orden
    </div>
    <div class="card-body">
      {% for product in cart_products %}
        <strong>{{ product.name }}</strong><br>
        {% if product.is_sale %}
          <strike>$ {{ product.price|currency_format }}</strike> &nbsp; $ {{ product.sale_price|currency_format }}
        {% else %}
          $ {{ product.price|currency_format }}
        {% endif %}
        <br>
        <small>Cantidad:</small>
        {% for key, value in quantities.items %}
          {% if key == product.id|slugify %}
            {{ value }}
          {% endif %}
        {% endfor %}
        <br><br>
      {% endfor %}
      
      <hr>
      
      <!-- Cupón aplicado (solo mostrar si existe) -->
      {% if coupon %}
        <div class="alert alert-danger py-2 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-ticket-perforated me-2"></i>
              <strong>Cupón: {{ coupon.code }}</strong><br>
              <small>{{ coupon.description }}</small>
            </div>
            <div class="text-end">
              <strong class="text-danger">-$ {{ coupon_discount|currency_format }}</strong>
            </div>
          </div>
        </div>
      {% endif %}
      
      <!-- Totales -->
      {% if coupon_discount > 0 %}
        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal:</span>
          <span>$ {{ total_original|currency_format }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2 text-danger">
          <span><i class="bi bi-tag-fill me-1"></i>Descuento:</span>
          <span>-$ {{ coupon_discount|currency_format }}</span>
        </div>
        <hr>
      {% endif %}

      <!-- Total siempre en la misma posición -->
      <h5 class="d-flex justify-content-between">
        <strong>Total:</strong>
        <strong class="text-danger">$ {{ total|currency_format }} CLP</strong>
      </h5>
      
      <small class="text-muted">(con IVA incluido)</small>
      
      <br><br>
      <a href="{% url 'cart_summary' %}" class="btn btn-sm btn-outline-secondary w-100">
        <i class="bi bi-pencil me-2"></i>Actualizar Items
      </a>
    </div>
  </div>
</div>


  </div>
</div>

<!-- Modal de Términos y Condiciones -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="termsModalLabel">
          <i class="bi bi-file-text me-2"></i>Términos y Condiciones
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6>1. Aceptación de los términos</h6>
        <p>Al utilizar nuestro sitio web y realizar una compra, usted acepta estar sujeto a estos Términos y Condiciones de venta. Si no está de acuerdo con estos términos, por favor no realice compras en nuestro sitio.</p>
        
        <h6>2. Productos y disponibilidad</h6>
        <p>Todos los repuestos de autos ofrecidos en nuestro sitio web están sujetos a disponibilidad. Nos reservamos el derecho de limitar las cantidades de cualquier producto que ofrecemos. Todas las descripciones de productos, imágenes, referencias y precios están sujetos a cambios sin previo aviso.</p>
        
        <h6>3. Precios y formas de pago</h6>
        <p>Todos los precios están expresados en pesos chilenos (CLP) e incluyen IVA. Nos reservamos el derecho de modificar nuestros precios en cualquier momento. Aceptamos las siguientes formas de pago: tarjetas de crédito, débito y transferencias bancarias.</p>
        
        <h6>4. Política de envío</h6>
        <p>Los tiempos de entrega estimados comienzan a contar desde la confirmación del pago. Los plazos pueden variar según la disponibilidad del producto y la ubicación de entrega. No nos hacemos responsables por retrasos ocasionados por servicios de mensajería externos.</p>
        
        <h6>5. Política de devoluciones y cambios</h6>
        <p>Aceptamos devoluciones dentro de los 30 días posteriores a la recepción del producto, siempre y cuando el artículo esté en su empaque original, sin uso y en perfectas condiciones. Los gastos de envío por devoluciones corren por cuenta del cliente, excepto en casos de productos defectuosos o errores en el envío.</p>
        
        <h6>6. Garantía</h6>
        <p>Todos nuestros productos cuentan con garantía del fabricante. La duración y cobertura de la garantía varía según el producto. Para hacer válida la garantía, debe presentar la factura de compra y el producto no debe haber sido manipulado o instalado incorrectamente.</p>
        
        <h6>7. Limitación de responsabilidad</h6>
        <p>No seremos responsables por daños indirectos, incidentales, especiales o consecuentes que resulten del uso o la imposibilidad de usar nuestros productos. Nuestra responsabilidad total no excederá el precio pagado por el producto.</p>
        
        <h6>8. Privacidad y protección de datos</h6>
        <p>Nos comprometemos a proteger su información personal de acuerdo con las leyes de protección de datos vigentes en Chile. Sus datos serán utilizados únicamente para procesar su pedido y mejorar nuestros servicios.</p>
        
        <h6>9. Modificaciones a los términos</h6>
        <p>Nos reservamos el derecho de modificar estos Términos y Condiciones en cualquier momento. Las modificaciones entrarán en vigor inmediatamente después de su publicación en el sitio web.</p>
        
        <h6>10. Ley aplicable y jurisdicción</h6>
        <p>Estos Términos y Condiciones se rigen por las leyes de la República de Chile. Cualquier disputa será resuelta en los tribunales competentes de Santiago, Chile.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i>Cerrar
        </button>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="acceptTermsBtn">
          <i class="bi bi-check-circle me-2"></i>Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const termsCheckbox = document.getElementById('termsCheckbox');
  const payButton = document.getElementById('payButton');
  const buttonText = document.getElementById('buttonText');
  const termsAcceptedInput = document.getElementById('termsAcceptedInput');
  const acceptTermsBtn = document.getElementById('acceptTermsBtn');
  const paymentForm = document.getElementById('paymentForm');
  const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
  const paymentInfo = document.getElementById('payment-info');

  // Habilitar/deshabilitar botón según checkbox
  termsCheckbox.addEventListener('change', function() {
    payButton.disabled = !this.checked;
    termsAcceptedInput.value = this.checked ? 'true' : '';
  });

  // Aceptar desde el modal
  acceptTermsBtn.addEventListener('click', function() {
    termsCheckbox.checked = true;
    payButton.disabled = false;
    termsAcceptedInput.value = 'true';
  });

  // Cambiar texto del botón según método de pago
  paymentMethods.forEach(method => {
    method.addEventListener('change', function() {
      if (this.value === 'transbank') {
        buttonText.textContent = 'Pagar Ahora';
        paymentInfo.innerHTML = '<i class="bi bi-shield-check me-2"></i><strong>Transbank:</strong> Serás redirigido a la pasarela de pago segura de Transbank para completar tu compra.';
        paymentInfo.className = 'alert alert-dark mt-3';
      } else if (this.value === 'bank_transfer') {
        buttonText.textContent = 'Hacer un Pedido';
        paymentInfo.innerHTML = '<i class="bi bi-info-circle me-2"></i><strong>Transferencia Bancaria:</strong> Tu pedido quedará pendiente hasta confirmar el pago. Recibirás un email con los datos bancarios.';
        paymentInfo.className = 'alert alert-warning mt-3';
      }
    });
  });

  // Validar antes de enviar el formulario
  paymentForm.addEventListener('submit', function(e) {
    if (!termsCheckbox.checked) {
      e.preventDefault();
      alert('Debes aceptar los Términos y Condiciones para continuar.');
      return false;
    }
    
    // Mostrar loading en el botón
    const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
    payButton.disabled = true;
    
    if (selectedMethod === 'transbank') {
      payButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando pago...';
    } else {
      payButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creando pedido...';
    }
  });
</script>

<style>
  /* Estilos para los labels de método de pago */
  label.btn-outline-payment {
    background-color: transparent;
    color: #212529;
    border-color: #dee2e6;
    border-width: 2px;
    transition: all 0.3s ease;
  }

  /* Hover */
  label.btn-outline-payment:hover {
    background-color: #f8f9fa;
    color: #212529;
    border-color: #adb5bd;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  /* Seleccionado: borde rojo */
  .btn-check:checked + label.btn-outline-payment {
    background-color: #fff5f5 !important;
    color: #212529 !important;
    border-color: #dc3545 !important;
    border-width: 3px !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.15);
  }

  /* Focus */
  label.btn-outline-payment:focus {
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.15);
  }

  /* Sticky sidebar */
  @media (min-width: 992px) {
    .sticky-top {
      position: sticky;
      top: 20px;
      z-index: 100;
    }
  }
</style>

<style>
  /* Estilos existentes... */
  
  /* Altura fija para opciones de pago */
  label.btn-outline-payment {
    min-height: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
</style>

<br/><br/>
{% endblock %}