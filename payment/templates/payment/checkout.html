{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<!-- Header -->
<header class="bg-dark py-5">
  <div class="container-fluid px-3 my-5">
    <div class="text-center text-white">
      <h1 class="display-4 fw-bolder">Checkout</h1>
      <p class="lead fw-normal text-white-50 mb-0">Revise su Orden</p>
    </div>
  </div>
</header>
<br/>

<div class="container-fluid px-3">
  <div class="row justify-content-between">

    <!-- Shipping Info centrado -->
    <div class="col-lg-6 mx-auto">
      
      {% if user.is_authenticated %}
        
        <!-- Personal Info -->
        <div class="card mb-4">
          <div class="card-header bg-danger text-white">
            <i class="bi bi-person-circle me-2"></i>Información Personal
          </div>
          <div class="card-body">
            <div class="mb-0"><strong>Nombre:</strong> {{ personal_info.full_name }}</div>
            <div class="mb-0"><strong>Teléfono:</strong> {{ personal_info.phone }}</div>
            <div class="mb-0"><strong>Email:</strong> {{ personal_info.email }}</div>
          </div>
        </div>

        <!-- Mensaje de destino -->
        <div class="alert {% if is_workshop_shipping %}alert-info{% else %}alert-dark{% endif %} text-center">
          {% if is_workshop_shipping %}
            <i class="bi bi-tools me-2"></i><strong>Este pedido será enviado al taller seleccionado.</strong>
          {% else %}
            <i class="bi bi-house-door me-2"></i><strong>Selecciona tu dirección de envío.</strong><br/>
            Todos nuestros envios son por pagar al currier nacional.
          {% endif %}
        </div>

        <!-- ====== FLUJO CON TALLER ====== -->
        {% if is_workshop_shipping %}
          <form method="POST" action="{% url 'checkout' %}">
            {% csrf_token %}
            <input type="hidden" name="workshop_id" value="{{ workshop_id }}">
            
            <div class="card mb-4">
              <div class="card-header bg-info text-white">
                <i class="bi bi-geo-alt me-2"></i>Dirección del Taller
              </div>
              <div class="card-body">
                <div class="mb-1"><strong>Taller:</strong> {{ shipping_form.shipping_full_name.value }}</div>
                <div class="mb-1"><strong>Dirección:</strong> {{ shipping_form.shipping_address1.value }}</div>
                <div class="mb-1"><strong>Ciudad:</strong> {{ shipping_form.shipping_city.value }}</div>
                <div class="mb-1"><strong>Region:</strong> {{ shipping_form.shipping_state.value }}</div>
                <div class="mb-1"><strong>Comuna:</strong> {{ shipping_form.shipping_commune.value }}</div>
                <div class="mb-1"><strong>Código Postal:</strong> {{ shipping_form.shipping_zipcode.value }}</div>
              </div>
            </div>

            <div class="d-flex justify-content-between">
              <a href="{% url 'workshop' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Volver a Talleres
              </a>
              <button type="submit" class="btn btn-danger">
                Continuar <i class="bi bi-arrow-right ms-2"></i>
              </button>
            </div>
          </form>

        <!-- ====== FLUJO SIN TALLER (DIRECCIONES PERSONALES) ====== -->
        {% else %}
          
          <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
              <span><i class="bi bi-geo-alt me-2"></i>Direcciones de Envío</span>
              {% if has_addresses %}
                <span class="badge bg-light text-dark">{{ shipping_addresses.count }}/10</span>
              {% endif %}
            </div>
            <div class="card-body">

              {% if has_addresses %}
                <!-- ====== DIRECCIONES EXISTENTES ====== -->
                <h6 class="mb-3">Selecciona una dirección:</h6>
                
                {% for address in shipping_addresses %}
                  <div class="card mb-3 {% if address.is_default %}border-danger{% endif %}">
                    <div class="card-body">
                      <div class="form-check">
                        <input 
                          class="form-check-input" 
                          type="radio" 
                          name="selected_address" 
                          id="address_{{ address.id }}"
                          value="{{ address.id }}"
                          {% if address.is_default %}checked{% endif %}
                        >
                        <label class="form-check-label w-100" for="address_{{ address.id }}">
                          {% if address.is_default %}
                            <span class="badge bg-danger mb-2">
                              <i class="bi bi-star-fill"></i> Principal
                            </span>
                          {% endif %}
                          
                          <h6 class="mb-2">{{ address.full_name }}</h6>
                          <p class="mb-0 text-muted small">
                            <i class="bi bi-envelope me-1"></i>{{ address.email }}<br>
                            <i class="bi bi-telephone me-1"></i>{{ address.phone }}<br>
                            <i class="bi bi-card-text me-1"></i>RUT/ID: {{ address.id_number}}<br>
                            <i class="bi bi-house me-1"></i>{{ address.address1 }}
                            {% if address.address2 %}, {{ address.address2 }}{% endif %}<br>
                            {{ address.commune }}, {{ address.city }}
                            {% if address.region %}, {{ address.region }}{% endif %}
                            {% if address.zipcode %} - {{ address.zipcode }}{% endif %}<br>
                            <i class="bi bi-globe me-1"></i>{{ address.country }}
                          </p>
                          
                          {% if address.notes %}
                            <div class="alert alert-light mt-2 mb-0 py-1">
                              <small>
                                <i class="bi bi-chat-left-text me-1"></i>
                                <strong>Nota:</strong> {{ address.notes }}
                              </small>
                            </div>
                          {% endif %}
                        </label>
                      </div>
                    </div>
                  </div>
                {% endfor %}

                <!-- Botón para agregar nueva dirección -->
                {% if can_add_more %}
                  <button 
                    class="btn btn-outline-danger w-100" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#newAddressForm"
                  >
                    <i class="bi bi-plus-circle me-2"></i>Agregar Nueva Dirección
                  </button>

                  <!-- ====== FORMULARIO NUEVA DIRECCIÓN (COLAPSABLE) ====== -->
                  <div class="collapse mt-3" id="newAddressForm">
                    <div class="card card-body bg-light">
                      <h6 class="mb-3">Nueva Dirección de Envío</h6>
                      <form method="POST" action="{% url 'checkout' %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_new_address">
                        
                        <div class="row">
                          <div class="col-md-6 mb-2">
                            {{ shipping_form.full_name.label_tag }}
                            {{ shipping_form.full_name }}
                          </div>
                          <div class="col-md-6 mb-2">
                            {{ shipping_form.email.label_tag }}
                            {{ shipping_form.email }}
                          </div>
                        </div>
                        
                        <div class="row">
                          <div class="col-md-6 mb-2">
                            {{ shipping_form.phone.label_tag }}
                            {{ shipping_form.phone }}
                          </div>
                          <div class="col-md-6 mb-2">
                              {{ shipping_form.id_number.label_tag }}
                              {{ shipping_form.id_number }}
                          </div>
                        </div>
                        
                        <div class="mb-2">
                          {{ shipping_form.address1.label_tag }}
                          {{ shipping_form.address1 }}
                        </div>
                        
                        <div class="row">
                          <div class="col-md-12 mb-2">
                            {{ shipping_form.address2.label_tag }}
                            {{ shipping_form.address2 }}
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-6 mb-2">
                            {{ shipping_form.commune.label_tag }}
                            {{ shipping_form.commune }}
                          </div>
                          <div class="col-md-6 mb-2">
                            {{ shipping_form.city.label_tag }}
                            {{ shipping_form.city }}
                          </div>
                        </div>
                        
                        <div class="row">
                          <div class="col-md-4 mb-2">
                            {{ shipping_form.region.label_tag }}
                            {{ shipping_form.region }}
                          </div>
                          <div class="col-md-4 mb-2">
                            {{ shipping_form.zipcode.label_tag }}
                            {{ shipping_form.zipcode }}
                          </div>
                          <div class="col-md-4 mb-2">
                            {{ shipping_form.country.label_tag }}
                            {{ shipping_form.country }}
                          </div>
                        </div>
                        
                        <div class="mb-2">
                          {{ shipping_form.notes.label_tag }}
                          {{ shipping_form.notes }}
                        </div>
                        
                        <button type="submit" class="btn btn-danger">
                          <i class="bi bi-plus-circle me-2"></i>Agregar y Usar Esta Dirección
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#newAddressForm">
                          Cancelar
                        </button>
                      </form>
                    </div>
                  </div>
                {% else %}
                  <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Has alcanzado el límite de 10 direcciones.
                  </div>
                {% endif %}

              {% else %}
                <!-- ====== NO TIENE DIRECCIONES - FORMULARIO DIRECTO ====== -->
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  No tienes direcciones guardadas. Agrega tu primera dirección.
                </div>

                <form method="POST" action="{% url 'checkout' %}">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="add_new_address">
                  
                  <div class="row">
                    <div class="col-md-6 mb-2">
                      {{ shipping_form.full_name.label_tag }}
                      {{ shipping_form.full_name }}
                    </div>
                    <div class="col-md-6 mb-2">
                      {{ shipping_form.email.label_tag }}
                      {{ shipping_form.email }}
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6 mb-2">
                      {{ shipping_form.phone.label_tag }}
                      {{ shipping_form.phone }}
                    </div>
                    <div class="col-md-6 mb-2">
                      {{ shipping_form.id_number.label_tag }}
                      {{ shipping_form.id_number }}
                    </div>
                  </div>
                  
                  <div class="mb-2">
                    {{ shipping_form.address1.label_tag }}
                    {{ shipping_form.address1 }}
                  </div>
                  
                  <div class="row">
                          <div class="col-md-12 mb-2">
                            {{ shipping_form.address2.label_tag }}
                            {{ shipping_form.address2 }}
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-6 mb-2">
                            {{ shipping_form.commune.label_tag }}
                            {{ shipping_form.commune }}
                          </div>
                          <div class="col-md-6 mb-2">
                            {{ shipping_form.city.label_tag }}
                            {{ shipping_form.city }}
                          </div>
                        </div>
                  
                  <div class="row">
                    <div class="col-md-4 mb-2">
                      {{ shipping_form.region.label_tag }}
                      {{ shipping_form.region }}
                    </div>
                    <div class="col-md-4 mb-2">
                      {{ shipping_form.zipcode.label_tag }}
                      {{ shipping_form.zipcode }}
                    </div>
                    <div class="col-md-4 mb-2">
                      {{ shipping_form.country.label_tag }}
                      {{ shipping_form.country }}
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    {{ shipping_form.notes.label_tag }}
                    {{ shipping_form.notes }}
                  </div>
                  
                  <button type="submit" class="btn btn-danger w-100">
                    <i class="bi bi-save me-2"></i>Guardar y Continuar
                  </button>
                </form>
              {% endif %}

            </div>
          </div>

<!-- Botones de navegación -->
          {% if has_addresses %}
            <form method="POST" action="{% url 'checkout' %}" id="select-address-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="select_address">
              <input type="hidden" name="address_id" id="selected_address_id" value="{{ shipping_addresses.first.id }}">
              
              <div class="d-flex justify-content-between mt-3">
                <a href="{% url 'cart_summary' %}" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-left me-2"></i>Volver al Carrito
                </a>
                <button type="submit" class="btn btn-danger">
                  Usar Dirección Seleccionada <i class="bi bi-arrow-right ms-2"></i>
                </button>
              </div>
            </form>
          {% else %}
            <div class="d-flex justify-content-between mt-3">
              <a href="{% url 'workshop' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Volver a Talleres
              </a>
            </div>
          {% endif %}

        {% endif %}

      <!-- ====== USUARIOS INVITADOS ====== -->
      {% else %}
        <form method="POST" action="{% url 'checkout' %}">
          {% csrf_token %}
          
          <div class="card mb-4">
            <div class="card-header bg-warning">
              <i class="bi bi-person me-2"></i>Información de Envío (Invitado)
            </div>
            <div class="card-body">
              <div class="mb-2">{{ guest_user_form.full_name.label_tag }} {{ guest_user_form.full_name }}</div>
              <div class="mb-2">{{ guest_user_form.phone.label_tag }} {{ guest_user_form.phone }}</div>
              <div class="mb-3">{{ guest_user_form.email.label_tag }} {{ guest_user_form.email }}</div>
              <div class="mb-2">{{ guest_user_form.id_number.label_tag }} {{ guest_user_form.id_number }}</div>
              <div class="mb-2">{{ guest_user_form.address1.label_tag }} {{ guest_user_form.address1 }}</div>
              <div class="mb-2">{{ guest_user_form.address2.label_tag }} {{ guest_user_form.address2 }}</div>
              <div class="mb-2">{{ guest_user_form.city.label_tag }} {{ guest_user_form.city }}</div>
              <div class="mb-2">{{ guest_user_form.state.label_tag }} {{ guest_user_form.state }}</div>
              <div class="mb-2">{{ guest_user_form.commune.label_tag }} {{ guest_user_form.commune }}</div>
              <div class="mb-2">{{ guest_user_form.zipcode.label_tag }} {{ guest_user_form.zipcode }}</div>
              <div class="mb-2">{{ guest_user_form.country.label_tag }} {{ guest_user_form.country }}</div>
            </div>
          </div>

          <div class="d-flex justify-content-between">
            <a href="{% url 'workshop' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-2"></i>Volver
            </a>
            <button type="submit" class="btn btn-danger">
              Continuar <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </form>
      {% endif %}

      <br><br>
    </div>

    <!-- Order summary on the right -->
<div class="col-md-4">
  <div class="card">
    <div class="card-header bg-dark text-white">
      <i class="bi bi-cart3 me-2"></i>Resumen de Orden
    </div>
    <div class="card-body">
      {% for product in cart_products %}
        <strong>{{ product.name }}</strong><br>
        {% if product.is_sale %}
          <strike>$ {{ product.price|currency_format }}</strike> &nbsp; $ {{ product.sale_price|currency_format }}
        {% else %}
          $ {{ product.price|currency_format }}
        {% endif %}
        <br>
        <small>Cantidad:</small>
        {% for key, value in quantities.items %}
          {% if key == product.id|slugify %}
            {{ value }}
          {% endif %}
        {% endfor %}
        <br><br>
      {% endfor %}
      
      <hr>
      
      <!-- NUEVO: Sección de Cupón -->
      <div class="mb-3">
        <h6><i class="bi bi-ticket-perforated me-2"></i>Cupón de Descuento</h6>
        
        {% if coupon %}
          <!-- Cupón aplicado -->
          <div class="alert alert-danger py-2 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ coupon.code }}</strong><br>
                <small>-$ {{ coupon_discount|currency_format }}</small>
              </div>
              <button type="button" class="btn btn-sm btn-outline-dark" id="remove-coupon-btn">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        {% else %}
          <!-- Formulario para aplicar cupón -->
          <div class="d-flex gap-2 mb-2">
            <input type="text" class="form-control" id="coupon-code" placeholder="Código de cupón" maxlength="50">
            <button class="btn btn-outline-secondary" type="button" id="apply-coupon-btn">
              Aplicar
            </button>
          </div>
          <div id="coupon-message"></div>
        {% endif %}
      </div>
      
      <hr>
      
<!-- Totales -->
{% if coupon_discount > 0 %}
  <div class="d-flex justify-content-between mb-2">
    <span>Subtotal:</span>
    <span>$ {{ total|currency_format }}</span>
  </div>
  <div class="d-flex justify-content-between mb-2 text-danger">
    <span>Descuento:</span>
    <span>-$ {{ coupon_discount|currency_format }}</span>
  </div>
  <hr>
{% endif %}

<!-- Total siempre en la misma posición -->
<h5 class="d-flex justify-content-between">
  <strong>Total:</strong>
  <strong class="text-danger">
    $ {% if coupon_discount > 0 %}{{ total_after_discount|currency_format }}{% else %}{{ total|currency_format }}{% endif %} CLP
  </strong>
</h5>
      
      <small class="text-muted">(con IVA incluido)</small>
      
      <br><br>
      <a href="{% url 'cart_summary' %}" class="btn btn-sm btn-outline-secondary w-100">
        <i class="bi bi-pencil me-2"></i>Actualizar Items
      </a>
    </div>
  </div>
</div>


  </div>
</div>

<br/><br/>

<!-- Script para actualizar el address_id seleccionado -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const radioButtons = document.querySelectorAll('input[name="selected_address"]');
  const hiddenInput = document.getElementById('selected_address_id');
  
  if (radioButtons && hiddenInput) {
    radioButtons.forEach(radio => {
      radio.addEventListener('change', function() {
        hiddenInput.value = this.value;
      });
    });
  }
});
</script>

<script>
// Aplicar cupón
document.getElementById('apply-coupon-btn')?.addEventListener('click', function() {
  const code = document.getElementById('coupon-code').value.trim();
  const messageDiv = document.getElementById('coupon-message');
  const btn = this;
  
  if (!code) {
    messageDiv.innerHTML = '<small class="text-danger">Ingresa un código</small>';
    return;
  }
  
  // Deshabilitar botón mientras procesa
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
  
  fetch("{% url 'validate_coupon' %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: `code=${encodeURIComponent(code)}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.valid) {
      // Cupón válido - recargar página para mostrar descuento
      location.reload();
    } else {
      // Mostrar error
      messageDiv.innerHTML = `<small class="text-danger">${data.message}</small>`;
      btn.disabled = false;
      btn.textContent = 'Aplicar';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    messageDiv.innerHTML = '<small class="text-danger">Error al aplicar cupón</small>';
    btn.disabled = false;
    btn.textContent = 'Aplicar';
  });
});

// Remover cupón
document.getElementById('remove-coupon-btn')?.addEventListener('click', function() {
  if (!confirm('¿Remover cupón?')) return;
  
  fetch("{% url 'remove_coupon' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    }
  })
  .catch(error => {
    console.error('Error:', error);
  });
});

// Permitir aplicar con Enter
document.getElementById('coupon-code')?.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('apply-coupon-btn').click();
  }
});
</script>

{% endblock %}